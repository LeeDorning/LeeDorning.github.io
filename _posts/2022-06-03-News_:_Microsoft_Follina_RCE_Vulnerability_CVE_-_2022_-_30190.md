---
layout: post
title: News - Microsoft 'Follina' RCE Vulnerability (CVE-2022-30190)
date: 2022-06-03
---

Information on the newly released Microsoft 'Follina' remote code execution vulnerability, dubbed CVE-2022-30190.

&nbsp;

---

&nbsp;

Right then, we’ve just had the first major vulnerability with widespread impact released since the creation of this blog, so let’s dig into the vulnerability itself, how to protect against it, and why it’s giving IT and Security teams headaches…Oh and throw in some memes too, obviously. 

&nbsp;
&nbsp;

## CVE-2022-30190 - ‘Follina’ Exploit

On Monday 30th May, Microsoft announced that a Remote Code Execution (RCE) vulnerability had been discovered in the Microsoft Support Diagnostic Tool (MSDT) in [this article](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190), designated as [CVE-2022-30190](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-30190) and given the nickname ‘Follina’. This vulnerability exists when an office application, such as Word, uses the URL protocol to call MSDT. This vulnerability has already been seen in the wild being exploited by threat actors and allows the attacker to run arbitrary code with the same privileges as the office application which is calling MSDT, providing an avenue for the attacker to ‘Install programs, view, change, or delete data, or create new accounts’. Yikes… Not something you want being exploited on your system then. 

The discovery of this vulnerability looks to have started out with a cyber researcher, known as [nao_sec](https://twitter.com/nao_sec), sharing a file they found on Virus Total that was using this exact method to run PowerShell commands remotely. Inspection by the cyber community confirmed that this was in fact an exploit for a Zero-Day in Microsoft Office, and it was quickly reproduced by a significant number of people, with one particular recreation worth noting being that of [Huntress Labs](https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug), who managed to create a Zero-Click variance of this exploit (Not good news at all). I would highly recommend giving their article a read to fully understand how this exploit works, since they go through every step in significant detail beyond that of this blog post, but in short the exploit does the following:

&nbsp;

Inside the exploit Word document, there is another file named document.xml.rels, which contains a reference to an online HTML document

![HTML Document Reference](https://github.com/LeeDorning/LeeDorning.github.io/blob/main/images/News_:_Microsoft_Follina_RCE_Vulnerability_CVE_-_2022_-_30190/TargetHtml.png?raw=true){:style="display:block; margin-left:auto; margin-right:auto"}{: width="600"}

*https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug*
{: style="text-align: center; font-size:75%"}

&nbsp;

This HTML document contains a large amount of commented out ‘A’ characters, which at first glance appears unnecessary but actually seems to be required for the exploit to run. At the end of this HTML document the MSDT tool is called with the parameter ***IT_BrowseForFile*** and includes some Base64 encoded PowerShell commands. When decoded these commands are as follows:

![BASE64 Decoded PowerShell Commands](https://github.com/LeeDorning/LeeDorning.github.io/blob/main/images/News_:_Microsoft_Follina_RCE_Vulnerability_CVE_-_2022_-_30190/DecodedCommands.png?raw=true){:style="display:block; margin-left:auto; margin-right:auto"}{: width="700"}

*https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug*
{: style="text-align: center; font-size:75%"}

&nbsp;

These commands perform the following actions, all within hidden windows, to allow for initial access to the exploited system for the attacker:

- Kills msdt.exe if it is running
- Loops through a RAR file to find a Base64 string for an encoded CAB file
- Saves this Base64 encoded CAB file
- Decodes the Base64 CAB file and saves the output
- Expands the decoded CAB file into the current directory
- Executes a specificed .exe which is presumed to be stored within the CAB file

Some very smart threat hunters have managed to develop versions of this exploit which run with a single click by saving the exploit as a .rtf file and using the preview pane within windows explorer to trigger the RCE, only needing the file to be selected and previewed and not even fully opened, so it’s pretty clear why this has got IT and Security team’s scrambling; It’s a readily available, easily exploited vulnerability with a high potential impact…scary stuff!

&nbsp;
&nbsp;

## Protecting Against ‘Follina’

#### Disabling the MSDT URL Protocol

Since this vulnerability is caused by MSDT being called by the URL protocol, the most logical way to mitigate some of the risk associated is to simply disable the URL protocol as a whole. This is a fairly simple process, although considerations need to be made for large scale environments as to the potential impact of making this change and how effective it will really be at mitigating this issue. To disable the URL protocol, you simply need to run the following commands as admin to back up the relevant registry key and then remove it:

~~~
reg export HKEY_CLASSES_ROOT\ms-msdt filename
reg delete HKEY_CLASSES_ROOT\ms-msdt /f
~~~

This will prevent troubleshooting tools from opening from links throughout your operating system, but they are still available from the ‘Get Help’ application, so this isn’t the end of the world. If this does cause any problems it is also easily undone, simply by restoring the backed-up registry key using the following:

~~~
reg import filename
~~~

&nbsp;

#### Windows Defender: Cloud-Delivered Protection and Sample Submission

If you are running Windows Defender, whether it be a corporate or personal system, Microsoft recommends that you enable Cloud-Delivered Protection and Automatic Sample Submission. This allows the Defender Antivirus to gain the latest information on Zero-Day exploits shared by Microsoft, and any samples which your system thinks are of interest will be automatically shared with Microsoft for investigation. This isn’t necessarily a ‘fix’ for this particular vulnerability but appears to be more of a best practice recommendation to ensure that your system is as secure as possible moving forwards. For corporate systems this setting will likely be managed through MDM software, but for personal systems you can activate the setting as follows:

***Open Windows Security***
{: style="text-align: center"}

![Windows Security](https://github.com/LeeDorning/LeeDorning.github.io/blob/main/images/News_:_Microsoft_Follina_RCE_Vulnerability_CVE_-_2022_-_30190/WindowsSecurity.png?raw=true){:style="display:block; margin-left:auto; margin-right:auto"}{: width="300"}

&nbsp;

***Under ‘Virus & Threat Protection’ select ‘Manage Settings’***
{: style="text-align: center"}

![Virus & Threat Protection Settings](https://github.com/LeeDorning/LeeDorning.github.io/blob/main/images/News_:_Microsoft_Follina_RCE_Vulnerability_CVE_-_2022_-_30190/VtpSettings.png?raw=true){:style="display:block; margin-left:auto; margin-right:auto"}{: width="500"}

&nbsp;

***Ensure the ‘Cloud-Delivered Protection’ and ‘Automatic Sample Submission’ toggles are enabled***
{: style="text-align: center"}

![Enable Cloud Protection and Automatic Sample Submission](https://github.com/LeeDorning/LeeDorning.github.io/blob/main/images/News_:_Microsoft_Follina_RCE_Vulnerability_CVE_-_2022_-_30190/EnableToggles.png?raw=true){:style="display:block; margin-left:auto; margin-right:auto"}{: width="500"}

&nbsp;

#### Attack Surface Reduction Rules

Customers of Microsoft Defender for Endpoint can also protect against the Follina vulnerability by enabling the ‘BlockOfficeCreateProcessRule’ attack surface reduction rule. This rule prevents office applications from spawning child processes, which is the entire MO of this vulnerability, so this should prevent the vast majority of exploits working on your system. Depending on how your Defender for Endpoint system is managed, whether it be through Intune, MEM or GPO, there are alternative methods for how to activate this attack surface reduction rule, all of which are provided in Microsoft’s documentation: [Enable Attack Surface Reduction Rules](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-attack-surface-reduction?view=o365-worldwide)

&nbsp;
&nbsp;

## Bypassing ‘BlockOfficeCreateProcessRule’
